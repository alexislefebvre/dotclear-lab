$(function(){$('#edit-entry').onetabload(function(){$('#linked-eventdatas').remove();$('#linked-eventdatas-form').remove();$('#eventdata_hide').remove();var target_form=$('#new-eventdata');var target_start=$('#eventdata-edit-start');var target_end=$('#eventdata-edit-end');var target_location=$('#eventdata-edit-location');var event_field=null;var post_id=$('#id');post_id=(post_id.length>0)?post_id.get(0).value:false;if(target_start.length>0){if(post_id==false){event_field=$('<input type="hidden" name="eventdata_hide" />');event_field.val('[f]'+$('#eventdata_start').val()+'||'+$('#eventdata_end').val()+'||'+$('#eventdata_location').val());}
var evEdit=new eventdataEditor(target_form,target_start,target_end,target_location,event_field);evEdit.displayEventdata('eventdata',post_id);}})});function eventdataEditor(target_form,target_start,target_end,target_location,event_field){this.target_form=target_form;this.target_start=target_start;this.target_end=target_end;this.target_location=target_location;this.event_field=event_field;};eventdataEditor.prototype={url_edit:'',title_list:'Linked events',text_confirm_remove:'Are you sure you want to remove this event?',text_action_add:'Add event to this entry',text_action_edit:'Edit this event',text_action_remove:'Delete this event',text_status_unsaved:'Waiting for save',text_status_none:'No event',type:null,dialog_start:null,dialog_end:null,dialog_location:null,target_form:null,target_start:null,target_end:null,target_location:null,event_field:null,post_id:false,service_uri:'services.php',displayEventdata:function(type,post_id){this.type=type;this.post_id=post_id;this.target_start.empty();this.target_end.empty();this.target_location.empty();this.dialog_start=$('<input type="text" />');this.dialog_end=$('<input type="text" />');this.dialog_location=$('<input type="text" />');var This=this;this.addEventdataDialog();if(this.post_id==false){this.target_form.append(this.event_field);}
this.displayEventdataList();},displayEventdataList:function(){var li;if(this.new_list==undefined){this.new_title=$('<h3 id="linked-eventdatas">'+this.title_list+'</h3>');this.new_list=$('<div class="p" id="linked-eventdatas-form"></div>');this.target_form.append(this.new_title).append(this.new_list);this.new_title.toggleWithLegend(this.new_list);this.new_title.hide();}
if(this.post_id==false){var ar_field=this.splitEventdataFields(this.event_field.val(),'[f]');this.new_list.empty();for(var i=0;i<ar_field.length;i++){li=$('<div class="eventdatas-list"></div>');var doit=false;var ar_value=this.splitEventdataFields(ar_field[i],'||');li.append('<span class="eventdata-waiting">'+this.text_status_unsaved+'</span>');for(var j=0;j<ar_value.length;j++){if(ar_value[j]!=''){li.append('<br />').append(ar_value[j]);doit=true;}}
if(doit==true){a_remove=$('<a class="eventdata-action-remove" title="'+this.text_action_remove+'" href="#">[x]</a>');a_remove.get(0).caller=this;a_remove.get(0).new_id=ar_field[i];a_remove.click(function(){this.caller.removeEventdata(this.new_id);return false;});li.prepend(a_remove);this.new_list.append(li);this.new_title.show();}}}else{var This=this;var params={f:'getEventdata',eventdataType:this.type,sortby:'eventdata_start,asc',postId:this.post_id};$.get(this.service_uri,params,function(data){data=$(data);if(data.find('rsp').attr('status')!='ok'){return;}
This.new_list.empty();data.find('eventdata').each(function(){li=$('<div class="eventdatas-list"></div>');var start=$(this).attr('start');var end=$(this).attr('end');var location=$(this).attr('location');var uri=$(this).attr('serializedURL');var field=start+'||'+end+'||'+location;li.append(start+'<br />'+end+'<br />'+location);li.prepend(' <a class="eventdata-action-edit" title="'+This.text_action_edit+'" href="'+This.url_edit+uri+'">[v]</a>');a_remove=$('<a class="eventdata-action-remove" title="'+This.text_action_remove+'" href="#">[x]</a>');a_remove.get(0).caller=This;a_remove.get(0).new_id=field;a_remove.click(function(){this.caller.removeEventdata(this.new_id);return false;});li.prepend(a_remove);This.new_list.append(li);This.new_title.show();});});}},addEventdataDialog:function(){var This=this;var S=$('<input type="button" title="'+This.text_action_add+'" value="ok" />');S.click(function(){var vs=This.dialog_start.val();var ve=This.dialog_end.val();var vl=This.dialog_location.val();This.addEventdata(vs,ve,vl);return false;});this.target_start.append($('<p></p>').append(this.dialog_start).append(' '));this.target_end.append($('<p></p>').append(this.dialog_end).append(' '));this.target_location.append($('<p></p>').append(this.dialog_location).append(' ').append(S));this.addEventdataDatepickers();},addEventdata:function(str_start,str_end,str_location){var test_str_start=str_start.replace(/^\d\d\d\d-\d\d-\d\d\s\d\d:\d\d$/,'');var test_str_end=str_end.replace(/^\d\d\d\d-\d\d-\d\d\s\d\d:\d\d$/,'');var testb_str_start=str_start.replace(/[-:\s]/g,"");var testb_str_end=str_end.replace(/[-:\s]/g,"");if(test_str_start==''&&test_str_end==''&&testb_str_start<testb_str_end){str=str_start+'||'+str_end+'||'+str_location;if(this.post_id==false){str=this.splitEventdataFields(this.event_field.val()+'[f]'+str);this.event_field.val(str);this.dialog_start.val('');this.dialog_end.val('');this.dialog_location.val('');this.new_list.toggle();this.displayEventdataList();}else{var params={xd_check:dotclear.nonce,f:'setEventdata',postId:this.post_id,eventdataType:this.type,eventdataStart:str_start,eventdataEnd:str_end,eventdataLocation:str_location};var This=this;$.post(this.service_uri,params,function(data){if($(data).find('rsp').attr('status')=='ok'){This.dialog_start.val('');This.dialog_end.val('');This.dialog_location.val('');This.new_list.toggle();This.displayEventdataList();}else{alert($(data).find('message').text());}});}}},removeEventdata:function(event_id){if(this.post_id==false){var field=this.splitEventdataFields(this.event_field.val(),'[f]');for(var i=0;i<field.length;i++){if(field[i]==event_id){field.splice(i,1);break;}}
this.event_field.val(field.join('[f]'));this.displayEventdataList();}else{var text_confirm_msg=this.text_confirm_remove.replace(/%s/,this.type);if(window.confirm(text_confirm_msg)){var This=this;var field=This.splitEventdataFields(event_id,'||');if(field[0]==''){var params={xd_check:dotclear.nonce,f:'delEventdata',postId:this.post_id,eventdataStart:field[1],eventdataEnd:field[2],eventdataType:this.type};}else{var params={xd_check:dotclear.nonce,f:'delEventdata',postId:this.post_id,eventdataStart:field[0],eventdataEnd:field[1],eventdataLocation:field[2],eventdataType:this.type};}
$.post(this.service_uri,params,function(data){if($(data).find('rsp').attr('status')=='ok'){This.displayEventdataList();}else{alert($(data).find('message').text());}});}}},splitEventdataFields:function(str,splitter){function inArray(needle,stack){for(var i=0;i<stack.length;i++){if(stack[i]==needle){return true;}}
return false;}
var res=new Array();var v=str.split(splitter);v.sort();for(var i=0;i<v.length;i++){v[i]=v[i].replace(/^\s*/,'').replace(/\s*$/,'');res.push(v[i]);}
res.sort();return res;},addEventdataDatepickers:function(){var start_dtPick=new datePickerB(this.dialog_start.get(0));start_dtPick.img_top='0.5em';start_dtPick.draw();var end_dtPick=new datePickerC(this.dialog_end.get(0));end_dtPick.img_top='0.5em';end_dtPick.draw();}};