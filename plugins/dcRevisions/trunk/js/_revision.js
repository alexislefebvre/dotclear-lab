dotclear.revisionExpander=function(){$('#revisions-list tr.line').each(function(){var img=document.createElement('img');img.src=dotclear.img_plus_src;img.alt=dotclear.img_plus_alt;img.className='expand';$(img).css('cursor','pointer');img.line=this;img.onclick=function(){dotclear.viewRevisionContent(this,this.line)};$(this).find('td.rid').prepend(img)})};dotclear.viewRevisionContent=function(img,line){var revisionId=line.id.substr(1),postId=$("#id").val(),tr=document.getElementById('re'+revisionId);if(!tr){tr=document.createElement('tr');tr.id='re'+revisionId;var td=document.createElement('td');td.colSpan=5;td.className='expand';tr.appendChild(td);img.src=dotclear.img_minus_src;img.alt=dotclear.img_minus_alt;$.get('services.php',{f:'getPatch',pid:postId,rid:revisionId},function(data){var rsp=$(data).children('rsp')[0];if(rsp.attributes[0].value=='ok'){var excerpt=$(rsp).find('post_excerpt_xhtml'),content=$(rsp).find('post_content_xhtml'),table='<table class="preview-rev"><thead><tr><th class="minimal nowrap">'+dotclear.msg.current+'</th><th class="minimal nowrap">r'+revisionId+'</th><th class="maximal"></th></tr></thead><tbody>';if(excerpt.size()>0)table+='<tr><td class="maximal center" colSpan="3"><strong>'+dotclear.msg.excerpt+'</strong></td></tr>';excerpt.find('line').each(function(){var class='',o=this.attributes[0].value,n=this.attributes[1].value,line=this.attributes[2].value;if(o!=''&&n=='')class=' delete';if(o==''&&n!='')class=' insert';table+='<tr><td class="minimal col-line">'+o+'</td><td class="minimal col-line">'+n+'</td><td class="maximal'+class+'">'+line+'</td></tr>'});if(content.size()>0)table+='<tr><td class="maximal center" colSpan="3"><strong>'+dotclear.msg.content+'</strong></td></tr>';content.find('line').each(function(){var class='',o=this.attributes[0].value,n=this.attributes[1].value,line=this.attributes[2].value;if(o!=''&&n=='')class=' delete';if(o==''&&n!='')class=' insert';table+='<tr><td class="minimal col-line">'+o+'</td><td class="minimal col-line">'+n+'</td><td class="maximal'+class+'">'+line+'</td></tr>'});table+='</tbody></table>';$(td).append(table)}else alert($(rsp).find('message').text())});$(line).toggleClass('expand');line.parentNode.insertBefore(tr,line.nextSibling)}else if(tr.style.display=='none'){$(tr).toggle();$(line).toggleClass('expand');img.src=dotclear.img_minus_src;img.alt=dotclear.img_minus_alt}else{$(tr).toggle();$(line).toggleClass('expand');img.src=dotclear.img_plus_src;img.alt=dotclear.img_plus_alt}};$(function(){$('#edit-entry').onetabload(function(){$('#revisions-area label').toggleWithLegend($('#revisions-area').children().not('label'),{cookie:'dcx_post_revisions',hide:$('#revisions_area').val()=='<p></p>',fn:dotclear.revisionExpander()});$('#revisions-list tr.line a.patch').click(function(){return window.confirm(dotclear.msg.confirm_apply_patch)})})})